# SillyTavern 记忆书 (STMB) 工作原理 — 轻编程指南

本指南以清晰、轻编程的术语解释 STMB 的工作原理，专为那些不编写 SillyTavern 代码但想了解提示如何构建的用户而设计。

## STMB 发送给 AI 的内容（记忆生成）

当您运行“生成记忆”时，STMB 会发送一个由两部分组成的提示：

A) 系统指令（来自“摘要”、“概要”等预设）
- 一个简短的指令块，用于：
  - 告知模型分析场景
  - 指示模型仅返回 JSON
  - 定义所需的 JSON 字段
- 像 {{user}} 和 {{char}} 这样的宏会被替换为您的聊天名称。
- 这不是您的预设！这些提示是独立的，可以从 🧩摘要提示管理器进行管理。

B) 用于分析的格式化场景
- STMB 会将您最近的消息格式化为脚本：
  - 可选的先前记忆上下文块（明确标记为“请勿摘要”）。
  - 当前场景的文字记录，每条消息一行：
    爱丽丝：…
    鲍勃：…

提示结构骨架
```
— 系统指令（来自您选择的预设）—
分析以下聊天场景并以 JSON 格式返回记忆。

您必须仅以这种确切的格式返回有效的 JSON：
{
  "title": "简短的场景标题（1-3 个词）",
  "content": "…",
  "keywords": ["…","…"]
}

…（预设指南继续；像 {{user}} 和 {{char}} 这样的宏已被替换）…

— 场景数据 —
=== 先前场景上下文（请勿摘要）===
上下文 1 - [标题]:
[先前的记忆文本]
关键词：阿尔法、贝塔、…
…（零个或多个先前的记忆）…
=== 先前场景上下文结束 - 仅摘要以下场景 ===

=== 场景文字记录 ===
{{user}}: …
{{char}}: …
…（每条消息占一行）
=== 场景结束 ===
```

注意
- 令牌安全：STMB 会估算令牌使用量，并在您超过阈值时发出警告。
- 如果您在“设置”中启用了传出正则表达式，STMB 会在发送前立即将您选择的正则表达式脚本应用于提示文本。

## AI 必须返回的内容（JSON 契约）

AI 必须返回一个包含以下字段的 JSON 对象：
- title: 字符串（短）
- content: 字符串（摘要/记忆文本）
- keywords: 字符串数组（预设推荐的 10-30 个特定术语）

严格性和兼容性
- 仅返回 JSON 对象 — 无散文、无解释。
- 键应完全为："title"、"content"、"keywords"。
  - STMB 容忍使用 "summary" 或 "memory_content" 作为内容，但 "content" 是最佳实践。
- keywords 必须是字符串数组（而不是逗号分隔的字符串）。

最小示例（有效）
```json
{
  "title": "安静的忏悔",
  "content": "深夜，爱丽丝承认黑客攻击是出于个人原因。鲍勃质疑其道德性；他们就界限达成一致，并计划下一步谨慎行事。",
  "keywords": ["爱丽丝", "鲍勃", "忏悔", "界限", "黑客攻击", "道德", "夜晚", "下一步"]
}
```

较长示例（有效）
```json
{
  "title": "屋顶休战",
  "content": "时间线：市场事件后的夜晚。故事情节：爱丽丝透露她安放了追踪器。鲍勃虽然沮丧但还是倾听了；他们重播了线索并确定了仓库。关键互动：爱丽丝毫无借口地道歉；鲍勃设定了继续合作的条件。值得注意的细节：坏掉的收音机、仓库标签“K-17”、远处的警报声。结果：他们达成了临时休战，并同意在黎明时侦察 K-17。",
  "keywords": ["爱丽丝", "鲍勃", "休战", "仓库 K-17", "道歉", "条件", "警报声", "侦察计划", "夜晚", "市场事件"]
}
```

### 如果模型行为不当

STMB 会尝试修复轻微格式错误的输出：
- 接受代码围栏内的 JSON 并提取该块。
- 在解析前删除注释和尾随逗号。
- 检测截断/不平衡的 JSON 并引发明确的错误，例如：
  - NO_JSON_BLOCK — 模型返回了散文而不是 JSON
  - UNBALANCED / INCOMPLETE_SENTENCE — 可能已截断
  - MISSING_FIELDS_TITLE / MISSING_FIELDS_CONTENT / INVALID_KEYWORDS — 架构问题

最佳模型行为
- 发出包含所需字段的单个 JSON 对象。
- 不要添加周围的文本或 Markdown 围栏。
- 保持“title”简短；使“keywords”具体且易于检索。
- 遵守预设（例如，忽略 [OOC] 内容）。

### 高级：执行路径（可选）

- 提示组装：buildPrompt(profile, scene) 将所选预设的指令文本与场景文字记录和可选的先前记忆块相结合。
- 发送：sendRawCompletionRequest() 将文本提交给您选择的提供商/模型。
- 解析：parseAIJsonResponse() 提取并验证标题/内容/关键字，并在需要时进行轻微修复。
- 结果：STMB 存储结构化记忆，应用您的标题格式，并准备建议的知识库密钥。

## 侧边提示（操作方法）

侧边提示是辅助性的、由模板驱动的生成器，可将结构化笔记写回您的知识库（例如，追踪器、报告、演员表）。它们与“记忆生成”路径分开，可以自动运行或按需运行。

它们的优点
- 情节/状态追踪器（例如，“情节要点”）
- 状态/关系仪表板（例如，“状态”）
- 演员表/NPC 简介（例如，“角色阵容”）
- POV 笔记或评估（例如，“评估”）

内置模板（由 STMB 提供）
- 情节要点 — 追踪故事线索和钩子
- 状态 — 总结关系/亲和力信息
- 角色阵容 — 按情节重要性顺序保留 NPC 列表
- 评估 — 记录 {{char}} 对 {{user}} 的了解

管理位置
- 打开侧边提示管理器（在 STMB 内）以查看、创建、导入/导出、启用或配置模板。

创建或启用侧边提示
1) 打开侧边提示管理器。
2) 创建一个新模板或启用一个内置模板。
3) 配置：
   - 名称：显示标题（保存的知识库条目将标题为“名称 (STMB SidePrompt)”）。
   - 提示：模型将遵循的指令文本。
   - 响应格式：附加到提示的可选指导块（不是架构，只是说明）。
   - 触发器：
     • 记忆后 — 在当前场景的每次成功记忆生成后运行。
     • 按间隔 — 当自上次运行以来可见的用户/助手消息达到阈值时运行 (visibleMessages)。
     • 手动命令 — 允许使用 /sideprompt 运行。
   - 可选上下文：previousMemoriesCount (0–7) 以包含最近的记忆作为只读上下文。
   - 模型/配置文件：可选择覆盖模型/配置文件 (overrideProfileEnabled + overrideProfileIndex)。否则，它将使用 STMB 默认配置文件（如果已配置，可以镜像当前的 ST UI 设置）。
   - 知识库注入设置：
     • constVectMode：链接（矢量化，默认）、绿色（正常）、蓝色（常量）
     • position：插入策略
     • orderMode/orderValue：需要时手动排序
     • preventRecursion/delayUntilRecursion：布尔标志

使用 /sideprompt 手动运行
- 语法：/sideprompt "名称" [X‑Y]
  - 示例：
    • /sideprompt "状态"
    • /sideprompt 演员表 100‑120
- 如果您省略范围，STMB 将编译自上次检查点以来的消息（限制在最近的窗口内）。
- 手动运行要求模板允许 sideprompt 命令（在模板设置中启用“允许通过 /sideprompt 手动运行”）。如果禁用，该命令将被拒绝。

自动运行
- 记忆后：所有启用了 onAfterMemory 触发器的模板都使用已编译的场景运行。STMB 以较小的并发限制批量运行，并可以显示每个模板的成功/失败信息。
- 间隔追踪器：启用了 onInterval 的模板在自上次运行以来可见的（非系统）消息数达到 visibleMessages 后运行。STMB 为每个模板存储检查点（例如，STMB_sp_<key>_lastMsgId）并对运行进行去抖动处理（约 10 秒）。为了安全起见，场景编译被限制在最近的窗口内。

预览和保存
- 如果在 STMB 设置中启用了“显示记忆预览”，则会出现一个预览弹出窗口。您可以接受、编辑、重试或取消。接受的内容将以“名称 (STMB SidePrompt)”为标题写入您绑定的知识库。
- 侧边提示需要将记忆知识库绑定到聊天（或在手动模式下选择）。如果未绑定，STMB 将显示通知并跳过运行。

导入/导出和内置重置
- 导出：将您的侧边提示文档另存为 JSON。
- 导入：以附加方式合并条目；重复项会被安全地重命名（不覆盖）。
- 重新创建内置模板：将内置模板重置为当前区域设置的默认值（用户创建的模板不受影响）。

## 侧边提示与记忆路径：主要区别

- 目的
  - 记忆路径：以严格的 JSON（标题、内容、关键字）格式生成规范的场景记忆，以供检索。
  - 侧边提示：以自由格式的文本生成辅助报告/追踪器，并保存到您的知识库中。

- 运行时间
  - 记忆路径：仅在您按下“生成记忆”时（或通过其工作流）运行。
  - 侧边提示：可以在记忆后、按间隔阈值或使用 /sideprompt 手动运行。

- 提示形状
  - 记忆路径：使用具有严格 JSON 契约的专用“摘要提示管理器”预设；STMB 验证/修复 JSON。
  - 侧边提示：使用模板的指令文本 + 可选的先前条目 + 可选的先前记忆 + 编译的场景文本；不需要 JSON 架构（可选的响应格式仅为指导）。

- 输出和存储
  - 记忆路径：一个 JSON 对象：{ title, content, keywords } → 作为用于检索的记忆条目存储。
  - 侧边提示：纯文本内容 → 作为标题为“名称 (STMB SidePrompt)”的知识库条目存储（旧名称会被识别以进行更新）。不需要关键字。

- 包含到聊天提示中
  - 记忆路径：通过标签/关键字、优先级、范围和令牌预算选择条目。
  - 侧边提示：包含由每个模板的知识库注入设置（常量与矢量化、位置、顺序）控制。

- 模型/配置文件选择
  - 记忆路径：使用 STMB 摘要提示管理器中定义的记忆配置文件。
  - 侧边提示：除非启用了模板级覆盖，否则使用 STMB 默认配置文件（可能镜像当前的 ST UI）。

- 并发和批处理
  - 记忆路径：每次生成运行一次。
  - 侧边提示：记忆后运行以有限的并发性进行批处理；结果可以分批预览和保存。

- 令牌/大小控制
  - 记忆路径：STMB 估算令牌使用量并强制执行 JSON 契约。
  - 侧边提示：编译一个有界的场景窗口，并可选择添加一些最近的记忆；没有严格的 JSON 强制执行。

## 常见问题解答式说明

- “这会改变我写消息的方式吗？”
  不会有太大变化。您主要负责管理条目，让 STMB 自动包含正确的条目。

- “我能看到实际发送给 AI 的内容吗？”
  可以——检查您的终端以检查注入的内容。
