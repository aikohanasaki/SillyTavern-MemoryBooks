# 📕 記憶書 (SillyTavern 擴充)

新一代 SillyTavern 擴充，用於自動、結構化和可靠地創建記憶。在聊天中標記場景，使用 AI 生成基於 JSON 的摘要，並將它們作為「[向量化](#向量化)」條目儲存在您的傳說書中。支援群聊、進階設定檔管理和穩定的 API/模型處理。

**📘 [使用者指南 (zh-tw)](USER_GUIDE.zh-tw.md)** |  **📋 [版本歷史與更新日誌](changelog.md)** | [使用 📕 Memory Books 搭配 📚 Lorebook Ordering](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20Traditional%20Chinese.md)

---

### 📚 搭配 Lorebook Ordering (STLO) 提升體驗

為了更進階的記憶管理與更深入的故事整合，強烈建議搭配 [SillyTavern-LorebookOrdering (STLO)](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20Traditional%20Chinese.md) 一起使用 STMB。請參閱指南以獲得最佳實務、設定說明與技巧！

> 注意：支援多種語言：請參閱 [`/locales`](locales) 資料夾以取得清單。國際化/本地化的自述檔案和使用者指南可以在 [`/userguides`](userguides) 資料夾中找到。
> 傳說書轉換器和側邊提示範本庫位於 [`/resources`](resources) 資料夾中。

## 常見問題
### 擴充選單中的條目在哪裡？
設定位於擴充選單中（輸入框左側的魔杖 🪄）。尋找「Memory Books」。

![STMB 設定位置](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/menu.png)

### 向量化？

世界資訊中的 🔗 條目在 ST 的 UI 中名為「vectorized」。這就是我使用「vectorized」這個詞的原因。如果您不使用向量擴充（我不用），它透過關鍵字工作。這一切都是自動化的，因此您不必考慮使用哪些關鍵字。

![ST 的策略下拉選單](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/vectorized.png)

![透過 AI 生成的關鍵字](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/keywords.png)

---

## 🚦 新功能 (v4.6.7)

### 🪲 各種錯誤修復
- 修復自動建立和自動摘要

### 🌐 國際化
- 持續國際化（請查看 [`/locales`](locales) 資料夾以取得清單。）

---

## 📋 先決條件

- **SillyTavern:** 1.13.4+ (建議使用最新版本)
- **為所有使用者安裝：** 由於 STMB 複用了 ST 基礎程式碼中的許多函式，請確保將擴充套件安裝為所有使用者，使路徑為 `/public/scripts/extensions/third-party/SillyTavern-MemoryBooks`。否則，函式匯入會失敗。
- **場景選擇：** 必須設定開始和結束標記（開始 < 結束）。
- **聊天補全支援：** 完全支援 OpenAI、Claude、Anthropic、OpenRouter 或其他聊天補全 API。
- **文字補全支援：** 當透過 SillyTavern 中的完全手動設定或自訂補全來源連接時，支援文字補全 API（Kobold、TextGen 等）。

### KoboldCpp 使用 📕 ST Memory Books 的提示
請在 ST 中設定這些（你可以在 STMB 正常運作後再切回文字補全）
- 聊天補全 API
- 自訂聊天補全來源
- `http://localhost:5001/v1` 端點（你也可以用 `127.0.0.1:5000/v1`）
- 「自訂 API 金鑰」隨便填什麼（無所謂，但 ST 需要）
- 模型 ID 必須是 `koboldcpp/模型名`（不要在模型名裡加 .gguf！）
- 下載並匯入一個聊天補全預設（任何一個都行），只是為了讓你有一個聊天補全預設。這樣可以避免「不支援」錯誤

## � 建議的全域世界資訊/傳說書啟用設定

- **符合整個單字：** 不勾選 (false)
- **掃描深度：** 越高越好 (至少 4)
- **最大遞迴步驟：** 2 (通用建議，非必需)
- **上下文百分比：** 40% (基於 100,000 個權杖的上下文視窗) - 假設您沒有超重的聊天歷史或機器人

---

## �🚀 入門指南

### 1. **安裝並載入**
- 載入 SillyTavern 並選擇一個角色或群聊。
- 等待 V 形按鈕 (► ◄) 出現在聊天訊息上（最多可能需要 10 秒）。

![等待這些按鈕](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/startup.png)

### 2. **標記一個場景**
- 在場景的第一條訊息上點擊 ►。
- 在最後一條訊息上點擊 ◄。

![顯示場景選擇的視覺回饋](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/button-start.png)

### 3. **建立一個記憶**
- 開啟擴充選單（魔杖 🪄）並點擊「Memory Books」，或使用 `/creatememory` 斜線命令。
- 如果出現提示，請確認設定（設定檔、上下文、API/模型）。
- 等待 AI 生成並自動建立傳說書條目。

---

## 🆕 斜線命令快捷方式

- `/creatememory` 將使用現有的 V 形開始/結束標記來建立一個記憶
- `/scenememory x-y` 將建立一個從訊息 x 開始到訊息 y 結束的記憶
- `/nextmemory` 將建立一個包含自上次記憶以來所有訊息的記憶。

## 👥 群聊支援

- 所有功能都支援群聊。
- 場景標記、記憶建立和傳說書整合儲存在群組元資料中。
- 無需特殊設定——只需選擇一個群聊並正常使用即可。

---

## 🧭 操作模式

### **自動模式 (預設)**
- **運作原理：** 自動使用綁定到目前聊天的傳說書。
- **最適合：** 簡單和快速。大多數使用者應該從這裡開始。
- **使用方法：** 確保在您的角色或群聊的「聊天傳說書」下拉選單中選擇了一個傳說書。

![聊天傳說書綁定範例](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/chatlorebook.png)

### **自動建立傳說書模式** ⭐ *v4.2.0 新功能*
- **運作原理：** 當沒有傳說書時，使用您的自訂命名範本自動建立並綁定一個新的傳說書。
- **最適合：** 新使用者和快速設定。非常適合一鍵建立傳說書。
- **使用方法：**
  1. 在擴充設定中啟用「如果不存在則自動建立傳說書」。
  2. 設定您的命名範本（預設：「LTM - {{char}} - {{chat}}」）。
  3. 當您在沒有綁定傳說書的情況下建立記憶時，會自動建立並綁定一個傳說書。
- **範本預留位置：** {{char}} (角色名稱), {{user}} (您的名稱), {{chat}} (聊天 ID)
- **智慧編號：** 如果存在重複名稱，則自動新增數字 (2, 3, 4...)。
- **注意：** 不能與手動傳說書模式同時使用。

### **手動傳說書模式**
- **運作原理：** 允許您為每個聊天的記憶選擇不同的傳說書，忽略主聊天綁定的傳說書。
- **最適合：** 希望將記憶定向到特定、獨立的傳說書的進階使用者。
- **使用方法：**
  1. 在擴充設定中啟用「啟用手動傳說書模式」。
  2. 在聊天中第一次建立記憶時，系統會提示您選擇一個傳說書。
  3. 此選擇將為該特定聊天儲存，直到您清除它或切換回自動模式。
- **注意：** 不能與自動建立傳說書模式同時使用。

---

## 📝 記憶生成

### **僅 JSON 輸出**
所有提示和預設**必須**指示 AI 僅返回有效的 JSON，例如：

```json
{
  "title": "簡短的場景標題",
  "content": "場景的詳細摘要...",
  "keywords": ["關鍵字1", "關鍵字2"]
}
```
**回應中不允許有其他文字。**

### **內建預設**
1. **Summary:** 詳細的逐拍摘要。
2. **Summarize:** 用於時間軸、節拍、互動、結果的 Markdown 標題。
3. **Synopsis:** 全面、結構化的 Markdown。
4. **Sum Up:** 帶有時間軸的簡潔節拍摘要。
5. **Minimal:** 1-2 句話的摘要。

### **自訂提示**
- 建立您自己的提示，但**必須**返回如上所述的有效 JSON。

---

## 📚 傳說書整合

- **自動建立條目：** 新記憶作為帶有所有元資料的條目儲存。
- **基於標誌的偵測：** 只有帶有 `stmemorybooks` 標誌的條目才被辨識為記憶。
- **自動編號：** 順序、零填充編號，支援多種格式 (`[000]`, `(000)`, `{000}`, `#000`)。
- **手動/自動順序：** 每個設定檔的插入順序設定。
- **編輯器重新整理：** 在新增記憶後可選擇自動重新整理傳說書編輯器。

> **現有記憶必須轉換！**
> 使用 [傳說書轉換器](/resources/lorebookconverter.html) 新增 `stmemorybooks` 標誌和必填欄位。

---

### 🎡 側邊提示

側邊提示可以像追蹤器一樣使用，並將在您的記憶傳說書中建立條目。
- **存取：** 從記憶書設定中，點擊「🎡 側邊提示管理器」。
- **功能：**
    - 查看所有側邊提示。
    - 建立新提示或複製提示以嘗試不同的提示風格。
    - 編輯或刪除任何預設（包括內建預設）。
    - 匯出和匯入預設為 JSON 檔案以進行備份或共用。
    - 手動執行或在建立記憶時自動執行。
- **使用技巧：**
    - 建立新提示時，您可以從內建提示中複製以獲得最佳相容性。
    - 額外的側邊提示範本庫 [JSON 檔案](resources/SidePromptTemplateLibrary.json) - 只需匯入即可使用

---

### 🧠 用於進階自訂的 Regex 整合
- **完全控制文字處理**：記憶書現在與 SillyTavern 的 **Regex** 擴充功能整合，讓您可以在兩個關鍵階段套用強大的文字轉換：
    1.  **提示生成**：透過建立針對 **使用者輸入** 位置的規則運算式指令碼，自動修改傳送給 AI 的提示。
    2.  **回應解析**：在儲存之前，透過針對 **AI 輸出** 位置來清理、重新格式化或標準化 AI 的原始回應。
- **多重選擇支援：** 現在您可以同時選擇多個正則腳本，所有啟用的腳本會在提示生成和回應解析階段依序應用，實現更進階和彈性的轉換。
- **運作方式**：整合是無縫的。只需在 Regex 擴充功能中建立並啟用您想要的指令碼，記憶書就會在建立記憶和側邊提示時自動套用它們。

---

## 👤 設定檔管理

- **設定檔：** 每個設定檔包括 API、模型、溫度、提示/預設、標題格式和傳說書設定。
- **匯入/匯出：** 以 JSON 格式共用設定檔。
- **設定檔建立：** 使用進階選項彈出視窗儲存新設定檔。
- **每個設定檔的覆寫：** 臨時切換 API/模型/溫度以建立記憶，然後還原您的原始設定。

---

## ⚙️ 設定與組態

![主設定面板](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/Main.png)

### **全域設定**
- **手動傳說書模式：** 啟用以按聊天選擇傳說書。
- **如果不存在則自動建立傳說書：** ⭐ *v4.2.0 新功能* - 使用您的命名範本自動建立並綁定傳說書。
- **傳說書名稱範本：** ⭐ *v4.2.0 新功能* - 使用 {{char}}、{{user}}、{{chat}} 預留位置自訂自動建立的傳說書名稱。
- **允許場景重疊：** 允許或阻止重疊的記憶範圍。
- **始終使用預設設定檔：** 略過確認彈出視窗。
- **顯示記憶預覽：** 啟用預覽彈出視窗以在新增到傳說書之前檢視和編輯記憶。
- **顯示通知：** 切換 Toast 訊息。
- **重新整理編輯器：** 在記憶建立後自動重新整理傳說書編輯器。
- **權杖警告閾值：** 為大型場景設定警告等級（預設：30,000）。
- **預設先前記憶：** 作為上下文包含的先前記憶數量 (0-7)。
- **自動建立記憶摘要：** 啟用按間隔自動建立記憶。
- **自動摘要間隔：** 自動建立記憶摘要的訊息數量（10-200，預設：100）。
- **記憶標題格式：** 選擇或自訂（見下文）。

![設定檔組態](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/Profile.png)

### **設定檔欄位**
- **名稱：** 顯示名稱。
- **API/提供者：** openai、claude、custom 等。
- **模型：** 模型名稱（例如，gpt-4、claude-3-opus）。
- **溫度：** 0.0–2.0。
- **提示或預設：** 自訂或內建。
- **標題格式：** 每個設定檔的範本。
- **啟用模式：** 向量化、常數、正常。
- **位置：** ↑Char, ↓Cha, ↑EM, ↓EM, ↑AN。
- **順序模式：** 自動/手動。
- **遞迴：** 阻止/延遲遞迴。

---

## 🏷️ 標題格式化

使用強大的範本系統自訂您的傳說書條目標題。

- **預留位置：**
  - `{{title}}` - AI 生成的標題（例如，「一次命運的相遇」）。
  - `{{scene}}` - 訊息範圍（例如，「場景 15-23」）。
  - `{{char}}` - 角色的名稱。
  - `{{user}}` - 您的使用者名稱。
  - `{{messages}}` - 場景中的訊息數量。
  - `{{profile}}` - 用於生成的設定檔的名稱。
  - 各種格式的目前日期/時間預留位置（例如，日期為 `2025年8月13日`，時間為 `晚上11:08`）。
- **自動編號：** 使用 `[0]`、`[00]`、`(0)`、`{0}`、`#0`，現在還支援包裝形式，如 `#[000]`、`([000])`、`{[000]}`，用於順序、零填充編號。
- **自訂格式：** 您可以建立自己的格式。從 v4.5.1 開始，標題中允許所有可列印的 Unicode 字元（包括表情符號、中日韓字元、重音符號、符號等）；僅阻止 Unicode 控制字元。

---

## 🧵 上下文記憶

- **最多包含 7 個先前的記憶**作為上下文，以獲得更好的連續性。
- **權杖估算**包括上下文記憶以確保準確性。

![帶有上下文的記憶生成](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/context.png)

---

## 🎨 視覺回饋與可及性

- **按鈕狀態：**
  - 非作用中、作用中、有效選擇、場景中、處理中。

![顯示所有視覺狀態的完整場景選擇](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/example.png)


- **可及性：**
  - 鍵盤導覽、焦點指示器、ARIA 屬性、減少動畫、行動裝置友善。

---

## 🛠️ 故障排除

- **沒有可用或選定的傳說書：**
  - 在手動模式下，在出現提示時選擇一個傳說書。
  - 在自動模式下，將一個傳說書綁定到您的聊天。
  - 或啟用「如果不存在則自動建立傳說書」以自動建立。

- **未選擇場景：**
  - 標記開始 (►) 和結束 (◄) 點。

- **場景與現有記憶重疊：**
  - 選擇不同的範圍，或在設定中啟用「允許場景重疊」。

![場景重疊警告](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/overlap.png)

- **AI 未能生成有效記憶：**
  - 使用支援 JSON 輸出的模型。
  - 檢查您的提示和模型設定。

- **超過權杖警告閾值：**
  - 使用較小的場景，或增加閾值。

- **缺少 V 形按鈕：**
  - 等待擴充載入，或重新整理。

- **角色資料不可用：**
  - 等待聊天/群組完全載入。

---

## 📝 字元策略 (v4.5.1+)

- **標題中允許：** 允許所有可列印的 Unicode 字元，包括重音字母、表情符號、中日韓字元和符號。
- **已阻止：** 僅阻止 Unicode 控制字元 (U+0000–U+001F, U+007F–U+009F)；這些字元會自動刪除。

有關範例和遷移說明，請參閱[字元策略詳情](charset.md)。
---

*用愛心使用 VS Code/Cline 開發，經過廣泛測試和社群回饋。* 🤖💕
