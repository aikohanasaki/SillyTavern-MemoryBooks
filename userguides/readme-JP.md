# 📕 メモリーブック（SillyTavern拡張機能）

自動的で構造化された、信頼性の高い記憶作成のための次世代SillyTavern拡張機能です。チャットでシーンをマークし、AIでJSONベースの要約を生成し、ロアブックに「[ベクトル化](#vectorized)」エントリとして保存します。グループチャット、高度なプロファイル管理、そして堅牢なAPI/モデルハンドリングをサポートしています。

**📘 [ユーザーガイド (JP)](USER_GUIDE.md)** |  **📋 [バージョン履歴と変更ログ](changelog.md)** | [📕 Memory Books と 📚 Lorebook Ordering の使い方](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20Japanese.md)

---

### 📚 Lorebook Ordering (STLO) でパワーアップ

高度なメモリ整理や物語の統合を強化するため、STMBと[SillyTavern-LorebookOrdering (STLO)](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20Japanese.md)の併用を強くおすすめします。ガイドではベストプラクティス、設定方法、コツなどが紹介されています。

> 注：多言語に対応しています：リストについては[`/locales`](locales)フォルダを参照してください。国際語/地域語のReadmeとユーザーガイドは[`/userguides`](userguides)フォルダにあります。
> ロアブックコンバーターとサイドプロンプトテンプレートライブラリは[`/resources`](resources)フォルダにあります。

## FAQ
### 拡張機能メニューのどこにありますか？
設定は拡張機能メニュー（入力ボックスの左にある魔法の杖🪄）にあります。「メモリーブック」を探してください。

![STMB設定の場所](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/menu.png)

### ベクトル化とは？

ワールド情報の🔗エントリは、STのUIで「ベクトル化」と名付けられています。これが私が「ベクトル化」という言葉を使う理由です。ベクトル拡張機能を使用しない場合（私は使用しません）、キーワードを介して機能します。これはすべて自動化されているため、どのキーワードを使用するかを考える必要はありません。

![STの戦略ドロップダウン](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/vectorized.png)

![AIによって生成されたキーワード](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/keywords.png)

---

## 🚦 新機能（v4.6.7）

### 🪲 様々なバグ修正
- 自動作成と自動要約を修正

### 🌐 国際化
- 国際化を継続（リストについては[`/locales`](locales)フォルダを確認してください。）

---

## 📋 前提条件

- **SillyTavern:** 1.13.4以降（最新版を推奨）
- **全ユーザー向けにインストール：** STMB は ST のベースコードの多くの関数を再利用するため、拡張機能が全ユーザー向けにインストールされ、場所が `/public/scripts/extensions/third-party/SillyTavern-MemoryBooks` になるようにしてください。そうしないと関数のインポートが失敗します。
- **シーン選択：** 開始マーカーと終了マーカー（開始 < 終了）が設定されている必要があります。
- **チャット補完サポート：** OpenAI、Claude、Anthropic、OpenRouter、またはその他のチャット補完APIを完全にサポートしています。
- **テキスト補完サポート：** テキスト補完API（Kobold、TextGenなど）は、SillyTavernの完全な手動設定またはカスタム補完ソースを介して接続されている場合にサポートされます。

### 📕 ST Memory BooksでKoboldCppを使用するためのヒント
STでこれを設定してください（STMBが動作した後でText Completionに戻すことができます）
- Chat Completion API
- カスタムチャット補完ソース
- `http://localhost:5001/v1` エンドポイント（`127.0.0.1:5000/v1`も使用できます）
- 「カスタムAPIキー」に何でも入力（何でも構いませんが、STには必要です）
- モデルIDは `koboldcpp/モデル名` である必要があります（モデル名に.ggufを入れないでください！）
- チャット補完プリセットをダウンロードしてインポートしてください（どれでも構いません）。チャット補完プリセットを持つためだけです。「サポートされていません」というエラーを避けることができます

## � 推奨されるグローバルワールド情報/ロアブックのアクティベーション設定

- **単語全体に一致：** チェックを外す（false）
- **スキャン深度：** 高い方が良い（少なくとも4）
- **最大再帰ステップ数：** 2（一般的な推奨であり、必須ではありません）
- **コンテキスト％：** 40％（100,000トークンのコンテキストウィンドウに基づく） - チャット履歴やボットが非常に重くないことを前提としています

---

## �🚀 はじめに

### 1. **インストールと読み込み**
- SillyTavernを読み込み、キャラクターまたはグループチャットを選択します。
- チャットメッセージにシェブロンボタン（► ◄）が表示されるまで待ちます（最大10秒かかる場合があります）。

![これらのボタンを待つ](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/startup.png)

### 2. **シーンをマークする**
- シーンの最初のメッセージで►をクリックします。
- 最後のメッセージで◄をクリックします。

![シーン選択を示す視覚的フィードバック](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/button-start.png)

### 3. **メモリを作成する**
- 拡張機能メニュー（魔法の杖🪄）を開き、「メモリーブック」をクリックするか、`/creatememory`スラッシュコマンドを使用します。
- プロンプトが表示されたら、設定（プロファイル、コンテキスト、API/モデル）を確認します。
- AIの生成と自動的なロアブックエントリの作成を待ちます。

---

## 🆕 スラッシュコマンドショートカット

- `/creatememory` は既存のシェブロン開始/終了マーカーを使用してメモリを作成します
- `/scenememory x-y` はメッセージxで始まりメッセージyで終わるメモリを作成します
- `/nextmemory` は最後のメモリ以降のすべてのメッセージでメモリを作成します

## 👥 グループチャットのサポート

- すべての機能はグループチャットで動作します。
- シーンマーカー、メモリ作成、ロアブック統合はグループメタデータに保存されます。
- 特別な設定は不要です—グループチャットを選択して通常通り使用するだけです。

---

## 🧭 操作モード

### **自動モード（デフォルト）**
- **仕組み：** 現在のチャットにバインドされているロアブックを自動的に使用します。
- **最適な用途：** シンプルさとスピード。ほとんどのユーザーはここから始めるべきです。
- **使用方法：** キャラクターまたはグループチャットの「チャットロアブック」ドロップダウンでロアブックが選択されていることを確認してください。

![チャットロアブックのバインディング例](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/chatlorebook.png)

### **ロアブック自動作成モード** ⭐ *v4.2.0の新機能*
- **仕組み：** カスタム命名テンプレートを使用して、存在しない場合に新しいロアブックを自動的に作成してバインドします。
- **最適な用途：** 新規ユーザーと迅速なセットアップ。ワンクリックでのロアブック作成に最適です。
- **使用方法：**
  1. 拡張機能の設定で「ロアブックが存在しない場合に自動作成」を有効にします。
  2. 命名テンプレートを設定します（デフォルト：「LTM - {{char}} - {{chat}}」）。
  3. バインドされたロアブックなしでメモリを作成すると、自動的に作成されてバインドされます。
- **テンプレートプレースホルダー：** {{char}}（キャラクター名）、{{user}}（あなたの名前）、{{chat}}（チャットID）
- **スマートナンバリング：** 重複する名前が存在する場合、自動的に番号（2、3、4...）を追加します。
- **注意：** 手動ロアブックモードと同時に使用することはできません。

### **手動ロアブックモード**
- **仕組み：** メインのチャットバインドロアブックを無視して、チャットごとにメモリ用の異なるロアブックを選択できます。
- **最適な用途：** メモリを特定の別のロアブックに向けたい上級ユーザー。
- **使用方法：**
  1. 拡張機能の設定で「手動ロアブックモードを有効にする」を有効にします。
  2. チャットで初めてメモリを作成するときに、ロアブックを選択するように求められます。
  3. この選択は、クリアするか自動モードに戻すまで、その特定のチャットに対して保存されます。
- **注意：** ロアブック自動作成モードと同時に使用することはできません。

---

## 📝 メモリ生成

### **JSONのみの出力**
すべてのプロンプトとプリセットは、AIに有効なJSONのみを返すように指示する**必要があります**。例：

```json
{
  "title": "短いシーンのタイトル",
  "content": "シーンの詳細な要約...",
  "keywords": ["キーワード1", "キーワード2"]
}
```
**応答に他のテキストは許可されません。**

### **組み込みプリセット**
1. **Summary:** 詳細なビートごとの要約。
2. **Summarize:** タイムライン、ビート、相互作用、結果のマークダウンヘッダー。
3. **Synopsis:** 包括的で構造化されたマークダウン。
4. **Sum Up:** タイムライン付きの簡潔なビート要約。
5. **Minimal:** 1〜2文の要約。

### **カスタムプロンプト**
- 独自のプロンプトを作成できますが、上記のように有効なJSONを返す**必要があります**。

---

## 📚 ロアブック統合

- **自動エントリ作成：** 新しいメモリはすべてのメタデータとともにエントリとして保存されます。
- **フラグベースの検出：** `stmemorybooks`フラグを持つエントリのみがメモリとして認識されます。
- **自動ナンバリング：** 複数のサポートされている形式（`[000]`、`(000)`、`{000}`、`#000`）を使用した、ゼロ埋めの連続番号付け。
- **手動/自動順序：** プロファイルごとの挿入順序設定。
- **エディタの更新：** メモリを追加した後にロアブックエディタをオプションで自動更新します。

> **既存のメモリは変換する必要があります！**
> [ロアブックコンバーター](/resources/lorebookconverter.html)を使用して、`stmemorybooks`フラグと必須フィールドを追加してください。

---

### 🎡 サイドプロンプト

サイドプロンプトはトラッカーのように使用でき、メモリロアブックにエントリを作成します。
- **アクセス：** メモリーブックの設定から、「🎡 サイドプロンプトマネージャー」をクリックします。
- **機能：**
    - すべてのサイドプロンプトを表示します。
    - 新しいプロンプトを作成または複製して、さまざまなプロンプトスタイルを試すことができます。
    - （組み込みを含む）任意のプリセットを編集または削除できます。
    - バックアップや共有のためにプリセットをJSONファイルとしてエクスポートおよびインポートできます。
    - 手動またはメモリ作成時に自動で実行します。
- **使用のヒント：**
    - 新しいプロンプトを作成する際は、互換性を最大限に高めるために組み込みのものをコピーすることをお勧めします。
    - 追加のサイドプロンプトテンプレートライブラリ[JSONファイル](resources/SidePromptTemplateLibrary.json) - インポートするだけで使用できます

---

### 🧠 高度なカスタマイズのためのRegex統合
- **テキスト処理の完全な制御**: Memory BooksはSillyTavernの**Regex**拡張機能と統合され、2つの主要な段階で強力なテキスト変換を適用できます：
    1.  **プロンプト生成**: **User Input**プレースメントをターゲットとする正規表現スクリプトを作成して、AIに送信されるプロンプトを自動的に変更します。
    2.  **応答の解析**: **AI Output**プレースメントをターゲットとして、保存される前にAIの生の応答をクリーンアップ、再フォーマット、または標準化します。
- **マルチセレクト対応：** 複数の正規表現スクリプトを同時に有効化でき、すべての有効なスクリプトがプロンプト生成や応答解析時に順番に適用され、より高度かつ柔軟な変換が可能です。
- **仕組み**: 統合はシームレスです。Regex拡張機能で目的のスクリプトを作成して有効にするだけで、Memory Booksはメモリおよびサイドプロンプトの作成中に自動的にそれらを適用します。

---

## 👤 プロファイル管理

- **プロファイル：** 各プロファイルには、API、モデル、温度、プロンプト/プリセット、タイトル形式、およびロアブック設定が含まれます。
- **インポート/エクスポート：** プロファイルをJSONとして共有します。
- **プロファイルの作成：** 詳細オプションポップアップを使用して新しいプロファイルを保存します。
- **プロファイルごとの上書き：** メモリ作成のためにAPI/モデル/温度を一時的に切り替え、その後元の設定に戻します。

---

## ⚙️ 設定と構成

![メイン設定パネル](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/Main.png)

### **グローバル設定**
- **手動ロアブックモード：** チャットごとにロアブックを選択できるようにします。
- **ロアブックが存在しない場合に自動作成：** ⭐ *v4.2.0の新機能* - 命名テンプレートを使用してロアブックを自動的に作成してバインドします。
- **ロアブック名テンプレート：** ⭐ *v4.2.0の新機能* - {{char}}、{{user}}、{{chat}}プレースホルダーを使用して、自動作成されるロアブック名をカスタマイズします。
- **シーンの重複を許可：** 重複するメモリ範囲を許可または禁止します。
- **常にデフォルトプロファイルを使用：** 確認ポップアップをスキップします。
- **メモリプレビューを表示：** プレビューポップアップを有効にして、ロアブックに追加する前にメモリを確認および編集します。
- **通知を表示：** トーストメッセージを切り替えます。
- **エディタを更新：** メモリ作成後にロアブックエディタを自動更新します。
- **トークン警告しきい値：** 大きなシーンの警告レベルを設定します（デフォルト：30,000）。
- **デフォルトの前のメモリ：** コンテキストとして含める前のメモリの数（0〜7）。
- **メモリ要約を自動作成：** 間隔を置いて自動メモリ作成を有効にします。
- **自動要約間隔：** メモリ要約を自動的に作成するまでのメッセージ数（10〜200、デフォルト：100）。
- **メモリタイトル形式：** 以下を参照して選択またはカスタマイズします。

![プロファイル設定](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/Profile.png)

### **プロファイルフィールド**
- **名前：** 表示名。
- **API/プロバイダー：** openai、claude、customなど。
- **モデル：** モデル名（例：gpt-4、claude-3-opus）。
- **温度：** 0.0–2.0。
- **プロンプトまたはプリセット：** カスタムまたは組み込み。
- **タイトル形式：** プロファイルごとのテンプレート。
- **アクティベーションモード：** ベクトル化、定数、通常。
- **位置：** ↑Char、↓Cha、↑EM、↓EM、↑AN。
- **順序モード：** 自動/手動。
- **再帰：** 再帰を防止/遅延。

---

## 🏷️ タイトルフォーマット

強力なテンプレートシステムを使用して、ロアブックエントリのタイトルをカスタマイズします。

- **プレースホルダー：**
  - `{{title}}` - AIによって生成されたタイトル（例：「運命の出会い」）。
  - `{{scene}}` - メッセージ範囲（例：「シーン15-23」）。
  - `{{char}}` - キャラクターの名前。
  - `{{user}}` - あなたのユーザー名。
  - `{{messages}}` - シーン内のメッセージ数。
  - `{{profile}}` - 生成に使用されたプロファイルの名前。
  - さまざまな形式の現在の日付/時刻プレースホルダー（例：日付の場合は`2025年8月13日`、時刻の場合は`午後11時08分`）。
- **自動ナンバリング：** `[0]`、`[00]`、`(0)`、`{0}`、`#0`、そして`#[000]`、`([000])`、`{[000]}`のようなラップされた形式を使用して、連続したゼロ埋めの番号付けを行います。
- **カスタムフォーマット：** 独自のフォーマットを作成できます。v4.5.1以降、絵文字、CJK、アクセント付き文字、記号など、すべての印刷可能なUnicode文字がタイトルで許可されます。Unicode制御文字のみがブロックされます。

---

## 🧵 コンテキストメモリ

- **最大7つの前のメモリ**をコンテキストとして含めることで、より良い継続性を実現します。
- **トークン推定**には、精度のためにコンテキストメモリが含まれます。

![コンテキスト付きのメモリ生成](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/context.png)

---

## 🎨 視覚的フィードバックとアクセシビリティ

- **ボタンの状態：**
  - 非アクティブ、アクティブ、有効な選択、シーン内、処理中。

![すべての視覚状態を示す完全なシーン選択](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/example.png)

- **アクセシビリティ：**
  - キーボードナビゲーション、フォーカスインジケーター、ARIA属性、モーションの削減、モバイルフレンドリー。

---

## 🛠️ トラブルシューティング

- **ロアブックが利用できない、または選択されていない：**
  - 手動モードでは、プロンプトが表示されたときにロアブックを選択します。
  - 自動モードでは、チャットにロアブックをバインドします。
  - または、「ロアブックが存在しない場合に自動作成」を有効にして自動作成します。

- **シーンが選択されていない：**
  - 開始（►）と終了（◄）の両方のポイントをマークします。

- **シーンが既存のメモリと重複している：**
  - 別の範囲を選択するか、設定で「シーンの重複を許可」を有効にします。

![シーンの重複警告](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/overlap.png)

- **AIが有効なメモリを生成できませんでした：**
  - JSON出力をサポートするモデルを使用してください。
  - プロンプトとモデルの設定を確認してください。

- **トークン警告しきい値を超えました：**
  - より小さいシーンを使用するか、しきい値を上げてください。

- **シェブロンボタンが表示されない：**
  - 拡張機能が読み込まれるのを待つか、更新してください。

- **キャラクターデータが利用できません：**
  - チャット/グループが完全に読み込まれるのを待ちます。

---

## 📝 文字ポリシー（v4.5.1以降）

- **タイトルで許可される文字：** アクセント付き文字、絵文字、CJK、記号など、すべての印刷可能なUnicode文字が許可されます。
- **ブロックされる文字：** Unicode制御文字（U+0000–U+001F、U+007F–U+009F）のみがブロックされます。これらは自動的に削除されます。

例と移行に関する注意点については、[文字ポリシーの詳細](charset.md)を参照してください。
---

*VS Code/Cline、広範なテスト、およびコミュニティのフィードバックを使用して愛情を込めて開発されました。* 🤖💕
