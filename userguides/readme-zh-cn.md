# 📕 记忆书 (SillyTavern 扩展)

新一代 SillyTavern 扩展，用于自动、结构化和可靠地创建记忆。在聊天中标记场景，使用 AI 生成基于 JSON 的摘要，并将它们作为“[向量化](#向量化)”条目存储在您的传说书中。支持群聊、高级配置文件管理和稳定的 API/模型处理。

⚠️‼️**请阅读[先决条件](#-先决条件)中的安装说明！**

**📘 [用户指南 (zh-cn)](USER_GUIDE.zh-cn.md)** |  **📋 [版本历史与更新日志](../changelog.md)** | [使用 📕 Memory Books 搭配 📚 Lorebook Ordering](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20Simplified%20Chinese.md)
> 已与英文 README 同步：e9f1709 (2025-10-31)

---

### 📚 搭配 Lorebook Ordering (STLO) 提升体验

为了更高级的记忆管理和更深层次的故事集成，强烈建议将 STMB 与 [SillyTavern-LorebookOrdering (STLO)](https://github.com/aikohanasaki/SillyTavern-LorebookOrdering/blob/main/guides/STMB%20and%20STLO%20-%20Simplified%20Chinese.md) 搭配使用。请参阅指南获取最佳实践、设置说明和技巧！

> 注意：支持多种语言：请参阅 [`/locales`](../locales) 文件夹以获取列表。国际化/本地化的自述文件和用户指南可以在 [`/userguides`](../userguides) 文件夹中找到。
> 传说书转换器和侧边提示模板库位于 [`/resources`](../resources) 文件夹中。

## 常见问题
### 扩展菜单中的条目在哪里？
设置位于扩展菜单中（输入框左侧的魔杖 🪄）。寻找“Memory Books”。

![STMB 设置位置](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/menu.png)

### 向量化？

世界信息中的 🔗 条目在 ST 的 UI 中名为“vectorized”。这就是我使用“vectorized”这个词的原因。如果您不使用向量扩展（我不用），它通过关键字工作。这一切都是自动化的，因此您不必考虑使用哪些关键字。

![ST 的策略下拉菜单](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/vectorized.png)

![通过 AI 生成的关键字](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/keywords.png)

---

## 🚦 新功能 (v4.6.10)

### 🌐 本地化/国际化
- 本地化的提示：
  - 英文提示已本地化，可用您的语言返回记忆。
  - 语言区域由 ST 的通用语言设置自动判定。
  - 新用户：无需任何操作；STMB 会自动检测并处理。
  - 现有用户：要切换到本地化的内置提示，请删除 `SillyTavern/data/(yourusername)/user/files/stmb-summary-prompts.json`，然后重新打开 Summary Prompt Manager。它会用本地化的内置提示重新创建。注意：如有修改，请先备份！

---

## 📋 先决条件

- **SillyTavern:** 1.13.5+ (建议使用最新版本)
- ⚠️‼️**为所有用户安装：**‼️⚠️ 由于 STMB 复用了 ST 基础代码中的许多函数，请确保将扩展安装为所有用户，使路径为 `/public/scripts/extensions/third-party/SillyTavern-MemoryBooks`。否则，函数导入会失败。
- **场景选择：** 必须设置开始和结束标记（开始 < 结束）。
- **聊天补全支持：** 完全支持 OpenAI、Claude、Anthropic、OpenRouter 或其他聊天补全 API。
- **文本补全支持：** 当通过 SillyTavern 中的完全手动配置或自定义补全源连接时，支持文本补全 API（Kobold、TextGen 等）。

### KoboldCpp 使用 📕 ST Memory Books 的提示
在 ST 中设置这些（在 STMB 正常工作后，你可以切回文本补全）
- 聊天补全 API
- 自定义聊天补全源
- `http://localhost:5001/v1` 端点（你也可以用 `127.0.0.1:5000/v1`）
- “自定义 API 密钥”中随便填什么（无所谓，但 ST 需要）
- 模型 ID 必须是 `koboldcpp/模型名`（不要在模型名里加 .gguf！）
- 下载并导入一个聊天补全预设（任何一个都行），只是为了让你有一个聊天补全预设。这样可以避免“不支持”错误

## � 推荐的全局世界信息/传说书激活设置

- **匹配整个单词：** 不勾选 (false)
- **扫描深度：** 越高越好 (至少 4)
- **最大递归步骤：** 2 (通用建议，非必需)
- **上下文百分比：** 40% (基于 100,000 个词符的上下文窗口) - 假设您没有超重的聊天历史或机器人

---

## �🚀 入门指南

### 1. **安装并加载**
- 加载 SillyTavern 并选择一个角色或群聊。
- 等待 V 形按钮 (► ◄) 出现在聊天消息上（最多可能需要 10 秒）。

![等待这些按钮](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/startup.png)

### 2. **标记一个场景**
- 在场景的第一条消息上点击 ►。
- 在最后一条消息上点击 ◄。

![显示场景选择的视觉反馈](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/button-start.png)

### 3. **创建一个记忆**
- 打开扩展菜单（魔杖 🪄）并点击“Memory Books”，或使用 `/creatememory` 斜杠命令。
- 如果出现提示，请确认设置（配置文件、上下文、API/模型）。
- 等待 AI 生成并自动创建传说书条目。

---

## 🆕 斜杠命令快捷方式

- `/creatememory` 将使用现有的 V 形开始/结束标记来创建一个记忆
- `/scenememory x-y` 将创建一个从消息 x 开始到消息 y 结束的记忆
- `/nextmemory` 将创建一个包含自上次记忆以来所有消息的记忆。

## 👥 群聊支持

- 所有功能都支持群聊。
- 场景标记、记忆创建和传说书集成存储在群组元数据中。
- 无需特殊设置——只需选择一个群聊并正常使用即可。

---

## 🧭 操作模式

### **自动模式 (默认)**
- **工作原理：** 自动使用绑定到当前聊天的传说书。
- **最适合：** 简单和快速。大多数用户应该从这里开始。
- **使用方法：** 确保在您的角色或群聊的“聊天传说书”下拉菜单中选择了一个传说书。

![聊天传说书绑定示例](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/chatlorebook.png)

### **自动创建传说书模式** ⭐ *v4.2.0 新功能*
- **工作原理：** 当没有传说书时，使用您的自定义命名模板自动创建并绑定一个新的传说书。
- **最适合：** 新用户和快速设置。非常适合一键创建传说书。
- **使用方法：**
  1. 在扩展设置中启用“如果不存在则自动创建传说书”。
  2. 配置您的命名模板（默认：“LTM - {{char}} - {{chat}}”）。
  3. 当您在没有绑定传说书的情况下创建记忆时，会自动创建并绑定一个传说书。
- **模板占位符：** {{char}} (角色名称), {{user}} (您的名称), {{chat}} (聊天 ID)
- **智能编号：** 如果存在重复名称，则自动添加数字 (2, 3, 4...)。
- **注意：** 不能与手动传说书模式同时使用。

### **手动传说书模式**
- **工作原理：** 允许您为每个聊天的记忆选择不同的传说书，忽略主聊天绑定的传说书。
- **最适合：** 希望将记忆定向到特定、独立的传说书的高级用户。
- **使用方法：**
  1. 在扩展设置中启用“启用手动传说书模式”。
  2. 在聊天中第一次创建记忆时，系统会提示您选择一个传说书。
  3. 此选择将为该特定聊天保存，直到您清除它或切换回自动模式。
- **注意：** 不能与自动创建传说书模式同时使用。

---

## 📝 记忆生成

### **仅 JSON 输出**
所有提示和预设**必须**指示 AI 仅返回有效的 JSON，例如：

```json
{
  "title": "简短的场景标题",
  "content": "场景的详细摘要...",
  "keywords": ["关键字1", "关键字2"]
}
```
**响应中不允许有其他文本。**

### **内置预设**
1. **Summary:** 详细的逐拍摘要。
2. **Summarize:** 用于时间线、节拍、互动、结果的 Markdown 标题。
3. **Synopsis:** 全面、结构化的 Markdown。
4. **Sum Up:** 带有时间线的简洁节拍摘要。
5. **Minimal:** 1-2 句话的摘要。

### **自定义提示**
- 创建您自己的提示，但**必须**返回如上所述的有效 JSON。

---

## 📚 传说书集成

- **自动创建条目：** 新记忆作为带有所有元数据的条目存储。
- **基于标志的检测：** 只有带有 `stmemorybooks` 标志的条目才被识别为记忆。
- **自动编号：** 顺序、零填充编号，支持多种格式 (`[000]`, `(000)`, `{000}`, `#000`)。
- **手动/自动顺序：** 每个配置文件的插入顺序设置。
- **编辑器刷新：** 在添加记忆后可选择自动刷新传说书编辑器。

> **现有记忆必须转换！**
> 使用 [传说书转换器](../resources/lorebookconverter.html) 添加 `stmemorybooks` 标志和必填字段。

---

### 🎡 侧边提示

侧边提示可以像跟踪器一样使用，并将在您的记忆传说书中创建条目。
- **访问：** 从记忆书设置中，点击“🎡 侧边提示管理器”。
- **功能：**
    - 查看所有侧边提示。
    - 创建新提示或复制提示以尝试不同的提示风格。
    - 编辑或删除任何预设（包括内置预设）。
    - 导出和导入预设为 JSON 文件以进行备份或共享。
    - 手动运行或在创建记忆时自动运行。
- **使用技巧：**
    - 创建新提示时，您可以从内置提示中复制以获得最佳兼容性。
    - 额外的侧边提示模板库 [JSON 文件](../resources/SidePromptTemplateLibrary.json) - 只需导入即可使用

---

### 🧠 用于高级定制的 Regex 集成
- **完全控制文本处理**：记忆书现在与 SillyTavern 的 **Regex** 扩展集成，允许您在两个关键阶段应用强大的文本转换：
    1.  **提示生成**：通过创建针对 **用户输入** 位置的正则表达式脚本，自动修改发送给 AI 的提示。
    2.  **响应解析**：在保存之前，通过针对 **AI 输出** 位置来清理、重新格式化或标准化 AI 的原始响应。
- **多选支持：** 现在您可以同时选择多个正则脚本；所有启用的脚本将在提示生成和响应解析阶段依次应用，实现更高级和灵活的转换。
- **工作原理**：集成是无缝的。只需在 Regex 扩展中创建并启用您想要的脚本，记忆书就会在创建记忆和侧边提示时自动应用它们。

---

## 👤 配置文件管理

- **配置文件：** 每个配置文件包括 API、模型、温度、提示/预设、标题格式和传说书设置。
- **导入/导出：** 以 JSON 格式共享配置文件。
- **配置文件创建：** 使用高级选项弹出窗口保存新配置文件。
- **每个配置文件的覆盖：** 临时切换 API/模型/温度以创建记忆，然后恢复您的原始设置。

---

## ⚙️ 设置与配置

![主设置面板](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/Main.png)

### **全局设置**
- **手动传说书模式：** 启用以按聊天选择传说书。
- **如果不存在则自动创建传说书：** ⭐ *v4.2.0 新功能* - 使用您的命名模板自动创建并绑定传说书。
- **传说书名称模板：** ⭐ *v4.2.0 新功能* - 使用 {{char}}、{{user}}、{{chat}} 占位符自定义自动创建的传说书名称。
- **允许场景重叠：** 允许或阻止重叠的记忆范围。
- **始终使用默认配置文件：** 跳过确认弹出窗口。
- **显示记忆预览：** 启用预览弹出窗口以在添加到传说书之前查看和编辑记忆。
- **显示通知：** 切换 Toast 消息。
- **刷新编辑器：** 在记忆创建后自动刷新传说书编辑器。
- **词符警告阈值：** 为大型场景设置警告级别（默认：30,000）。
- **默认先前记忆：** 作为上下文包含的先前记忆数量 (0-7)。
- **自动创建记忆摘要：** 启用按间隔自动创建记忆。
- **自动摘要间隔：** 自动创建记忆摘要的消息数量（10-200，默认：100）。
- **记忆标题格式：** 选择或自定义（见下文）。

![配置文件配置](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/Profile.png)

### **配置文件字段**
- **名称：** 显示名称。
- **API/提供商：** openai、claude、custom 等。
- **模型：** 模型名称（例如，gpt-4、claude-3-opus）。
- **温度：** 0.0–2.0。
- **提示或预设：** 自定义或内置。
- **标题格式：** 每个配置文件的模板。
- **激活模式：** 向量化、常量、正常。
- **位置：** ↑Char, ↓Cha, ↑EM, ↓EM, ↑AN, Outlet（以及字段名称）。
- **顺序模式：** 自动/手动。
- **递归：** 阻止/延迟递归。

---

## 🏷️ 标题格式化

使用强大的模板系统自定义您的传说书条目标题。

- **占位符：**
  - `{{title}}` - AI 生成的标题（例如，“一次命运的相遇”）。
  - `{{scene}}` - 消息范围（例如，“场景 15-23”）。
  - `{{char}}` - 角色的名称。
  - `{{user}}` - 您的用户名。
  - `{{messages}}` - 场景中的消息数量。
  - `{{profile}}` - 用于生成的配置文件的名称。
  - 各种格式的当前日期/时间占位符（例如，日期为 `2025年8月13日`，时间为 `晚上11:08`）。
- **自动编号：** 使用 `[0]`、`[00]`、`(0)`、`{0}`、`#0`，现在还支持包装形式，如 `#[000]`、`([000])`、`{[000]}`，用于顺序、零填充编号。
- **自定义格式：** 您可以创建自己的格式。从 v4.5.1 开始，标题中允许所有可打印的 Unicode 字符（包括表情符号、中日韩字符、重音符号、符号等）；仅阻止 Unicode 控制字符。

---

## 🧵 上下文记忆

- **最多包含 7 个先前的记忆**作为上下文，以获得更好的连续性。
- **词符估算**包括上下文记忆以确保准确性。

![带有上下文的记忆生成](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/context.png)

---

## 🎨 视觉反馈与可访问性

- **按钮状态：**
  - 非活动、活动、有效选择、场景中、处理中。

![显示所有视觉状态的完整场景选择](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/example.png)


- **可访问性：**
  - 键盘导航、焦点指示器、ARIA 属性、减少动画、移动设备友好。

---

## 🛠️ 故障排除

- **没有可用或选定的传说书：**
  - 在手动模式下，在出现提示时选择一个传说书。
  - 在自动模式下，将一个传说书绑定到您的聊天。
  - 或启用“如果不存在则自动创建传说书”以自动创建。

- **未选择场景：**
  - 标记开始 (►) 和结束 (◄) 点。

- **场景与现有记忆重叠：**
  - 选择不同的范围，或在设置中启用“允许场景重叠”。

![场景重叠警告](https://github.com/aikohanasaki/imagehost/blob/main/STMemoryBooks/overlap.png)

- **AI 未能生成有效记忆：**
  - 使用支持 JSON 输出的模型。
  - 检查您的提示和模型设置。

- **超过词符警告阈值：**
  - 使用较小的场景，或增加阈值。

- **缺少 V 形按钮：**
  - 等待扩展加载，或刷新。

- **角色数据不可用：**
  - 等待聊天/群组完全加载。

---

## 📝 字符策略 (v4.5.1+)

- **标题中允许：** 允许所有可打印的 Unicode 字符，包括重音字母、表情符号、中日韩字符和符号。
- **已阻止：** 仅阻止 Unicode 控制字符 (U+0000–U+001F, U+007F–U+009F)；这些字符会自动删除。

有关示例和迁移说明，请参阅[字符策略详情](../charset.md)。
---

*用爱心使用 VS Code/Cline 开发，经过广泛测试和社区反馈。* 🤖💕
