# SillyTavern Memory Books (STMB) の仕組み — プログラマー向けでないガイド

このガイドは、SillyTavern のコードを書かないけれど、プロンプトがどのように構築されるかを理解したいユーザーのために、STMB の仕組みを専門用語を避けて分かりやすく説明します。

## STMB が AI に送信するもの（メモリ生成）

「メモリを生成」を実行すると、STMB は 2 部構成のプロンプトを送信します。

A) システム指示（「要約」「あらすじ」などのプリセットから）
- 短い指示ブロックで、以下の内容を含みます。
  - モデルにシーンを分析するように指示
  - JSON のみを返すように指示
  - 必要な JSON フィールドを定義
- {{user}} や {{char}} などのマクロは、チャットの名前に置き換えられます。
- これはあなたのプリセットではありません！これらのプロンプトはスタンドアロンであり、🧩サマリープロンプトマネージャーから管理できます。

B) 分析用にフォーマットされたシーン
- STMB は、最近のメッセージをスクリプトのようにフォーマットします。
  - 以前のメモリのオプションのコンテキストブロック（要約しないように明確にマークされています）。
  - 現在のシーンのトランスクリプト、メッセージごとに 1 行：
    アリス：…
    ボブ：…

プロンプトの骨格
```
— システム指示（選択したプリセットから） —
次のチャットシーンを分析し、メモリを JSON として返してください。

この正確な形式で有効な JSON のみを応答する必要があります：
{
  "title": "短いシーンのタイトル（1〜3語）",
  "content": "…",
  "keywords": ["…","…"]
}

…（プリセットのガイダンスが続く。{{user}} や {{char}} などのマクロはすでに置換済み）…

— シーンデータ —
=== 以前のシーンのコンテキスト（要約しない） ===
コンテキスト 1 - [タイトル]:
[以前のメモリテキスト]
キーワード：アルファ、ベータ、…
…（0 個以上の以前のメモリ）…
=== 以前のシーンのコンテキストの終わり - 以下はシーンのみを要約 ===

=== シーントランスクリプト ===
{{user}}: …
{{char}}: …
…（各メッセージは独自の行に）
=== シーンの終わり ===
```

注
- トークンの安全性：STMB はトークンの使用量を見積もり、しきい値を超えると警告します。
- 設定で送信正規表現を有効にしている場合、STMB は送信直前に選択した正規表現スクリプトをプロンプトテキストに適用します。

## AI が返すべきもの（JSON 契約）

AI は、これらのフィールドを持つ単一の JSON オブジェクトを返す必要があります。
- title: string（短い）
- content: string（要約/メモリテキスト）
- keywords: string の配列（プリセットで推奨される 10〜30 の特定の用語）

厳密さと互換性
- JSON オブジェクトのみを返してください — 説明や散文は不要です。
- キーは正確に「title」、「content」、「keywords」である必要があります。
  - STMB は content に「summary」または「memory_content」を許容しますが、「content」がベストプラクティスです。
- keywords は文字列の配列である必要があります（カンマ区切りの文字列ではありません）。

最小限の例（有効）
```json
{
  "title": "静かな告白",
  "content": "深夜、アリスはハッキングが個人的なものだったと認める。ボブは倫理に疑問を呈し、彼らは境界線に合意し、慎重な次のステップを計画する。",
  "keywords": ["アリス", "ボブ", "告白", "境界線", "ハッキング", "倫理", "夜", "次のステップ"]
}
```

長い例（有効）
```json
{
  "title": "屋上の停戦",
  "content": "タイムライン：市場の事件の後の夜。ストーリービート：アリスは自分が追跡装置を仕掛けたと明かす。ボブは不満だが耳を傾け、彼らは手がかりを再生し、倉庫を特定する。主要な相互作用：アリスは言い訳なしで謝罪し、ボブは継続するための条件を設定する。注目すべき詳細：壊れたラジオ、倉庫のラベル「K-17」、遠くのサイレン。結果：彼らは暫定的な停戦を結び、夜明けに K-17 を偵察することに同意する。",
  "keywords": ["アリス", "ボブ", "停戦", "倉庫 K-17", "謝罪", "条件", "サイレン", "偵察計画", "夜", "市場の事件"]
}
```

### モデルが誤動作した場合

STMB は、わずかに不正な形式の出力を修正しようとします。
- コードフェンス内の JSON を受け入れ、ブロックを抽出します。
- 解析前にコメントと末尾のカンマを削除します。
- 切り捨てられた/不均衡な JSON を検出し、次のような明確なエラーを発生させます。
  - NO_JSON_BLOCK — モデルが JSON の代わりに散文で応答した
  - UNBALANCED / INCOMPLETE_SENTENCE — 切り捨てられた可能性が高い
  - MISSING_FIELDS_TITLE / MISSING_FIELDS_CONTENT / INVALID_KEYWORDS — スキーマの問題

最適なモデルの動作
- 必要なフィールドを持つ単一の JSON オブジェクトを出力します。
- 周囲のテキストや Markdown フェンスを追加しないでください。
- 「title」を短くし、「keywords」を具体的で検索しやすいものにしてください。
- プリセットに従ってください（例：[OOC] コンテンツを無視する）。

### 上級：実行パス（オプション）

- プロンプトの組み立て：buildPrompt(profile, scene) は、選択したプリセットの指示テキストと、シーンのトランスクリプト、およびオプションの以前のメモリブロックを組み合わせます。
- 送信：sendRawCompletionRequest() は、選択したプロバイダー/モデルにテキストを送信します。
- 解析：parseAIJsonResponse() は、title/content/keywords を抽出し、必要に応じて軽い修正を加えて検証します。
- 結果：STMB は構造化されたメモリを保存し、タイトル形式を適用し、提案されたロアブックキーを準備します。

## サイドプロンプト（ハウツー）

サイドプロンプトは、テンプレート駆動型の補助的なジェネレーターで、構造化されたメモをロアブックに書き戻します（例：トラッカー、レポート、キャストリスト）。これらは「メモリ生成」パスとは別のもので、自動またはオンデマンドで実行できます。

得意なこと
- プロット/状態トラッカー（例：「プロットポイント」）
- ステータス/関係ダッシュボード（例：「ステータス」）
- キャストリスト/NPC の人物紹介（例：「登場人物」）
- POV ノートまたは評価（例：「評価」）

組み込みテンプレート（STMB に同梱）
- プロットポイント — 物語の筋書きや伏線を追跡します
- ステータス — 関係/親和性情報を要約します
- 登場人物 — プロットの重要度順に NPC リストを保持します
- 評価 — {{char}} が {{user}} について学んだことを記録します

管理場所
- サイドプロンプトマネージャー（STMB 内）を開き、テンプレートの表示、作成、インポート/エクスポート、有効化、または設定を行います。

サイドプロンプトの作成または有効化
1) サイドプロンプトマネージャーを開きます。
2) 新しいテンプレートを作成するか、組み込みのテンプレートを有効にします。
3) 設定：
   - 名前：表示タイトル（保存されたロアブックエントリのタイトルは「名前（STMB SidePrompt）」になります）。
   - プロンプト：モデルが従う指示テキスト。
   - 応答形式：プロンプトに追加されるオプションのガイダンスブロック（スキーマではなく、単なる指示です）。
   - トリガー：
     • メモリ後 — 現在のシーンのメモリ生成が成功するたびに実行されます。
     • 間隔ごと — 最後の実行以降の表示可能なユーザー/アシスタントメッセージのしきい値に達したときに実行されます（visibleMessages）。
     • 手動コマンド — /sideprompt での実行を許可します。
   - オプションのコンテキスト：previousMemoriesCount（0〜7）で、最近のメモリを読み取り専用コンテキストとして含めます。
   - モデル/プロファイル：オプションでモデル/プロファイルを上書きします（overrideProfileEnabled + overrideProfileIndex）。それ以外の場合は、STMB のデフォルトプロファイルを使用します（設定されていれば、現在の ST UI 設定をミラーリングできます）。
   - ロアブック挿入設定：
     • constVectMode：リンク（ベクトル化、デフォルト）、緑（通常）、青（定数）
     • position：挿入戦略
     • orderMode/orderValue：必要な場合の手動順序付け
     • preventRecursion/delayUntilRecursion：ブール値フラグ

/sideprompt での手動実行
- 構文：/sideprompt "名前" [X‑Y]
  - 例：
    • /sideprompt "ステータス"
    • /sideprompt キャスト 100‑120
- 範囲を省略した場合、STMB は最後のチェックポイント以降のメッセージをコンパイルします（最近のウィンドウに制限されます）。
- 手動実行には、テンプレートが sideprompt コマンドを許可する必要があります（テンプレート設定で「/sideprompt による手動実行を許可」を有効にします）。無効になっている場合、コマンドは拒否されます。

自動実行
- メモリ後：onAfterMemory トリガーを持つすべての有効なテンプレートは、すでにコンパイルされたシーンを使用して実行されます。STMB は、小さな同時実行制限で実行をバッチ処理し、テンプレートごとの成功/失敗トーストを表示できます。
- 間隔トラッカー：onInterval を持つ有効なテンプレートは、最後の実行以降の表示可能な（システム以外の）メッセージ数が visibleMessages に達すると実行されます。STMB はテンプレートごとにチェックポイントを保存し（例：STMB_sp_<key>_lastMsgId）、実行をデバウンスします（〜10 秒）。シーンのコンパイルは、安全のために最近のウィンドウに制限されます。

プレビューと保存
- STMB 設定で「メモリプレビューを表示」が有効になっている場合、プレビューポップアップが表示されます。受け入れる、編集する、再試行する、またはキャンセルすることができます。受け入れられたコンテンツは、バインドされたロアブックに「名前（STMB SidePrompt）」というタイトルで書き込まれます。
- サイドプロンプトには、チャットにバインドされた（または手動モードで選択された）メモリロアブックが必要です。バインドされていない場合、STMB は通知を表示して実行をスキップします。

インポート/エクスポートと組み込みのリセット
- エクスポート：サイドプロンプトドキュメントを JSON として保存します。
- インポート：エントリを追加的にマージします。重複は安全に名前が変更されます（上書きなし）。
- 組み込みの再作成：組み込みテンプレートを現在のロケールのデフォルトにリセットします（ユーザーが作成したテンプレートは変更されません）。

## サイドプロンプトとメモリパス：主な違い

- 目的
  - メモリパス：検索のために、厳密な JSON（タイトル、コンテンツ、キーワード）として正規のシーンメモリを生成します。
  - サイドプロンプト：ロアブックに保存される自由形式のテキストとして、補助的なレポート/トラッカーを生成します。

- 実行タイミング
  - メモリパス：メモリを生成を押したとき（またはそのワークフロー経由）にのみ実行されます。
  - サイドプロンプト：メモリ後、間隔のしきい値、または /sideprompt で手動で実行できます。

- プロンプトの形状
  - メモリパス：厳密な JSON 契約を持つ専用の「サマリープロンプトマネージャー」プリセットを使用し、STMB が JSON を検証/修復します。
  - サイドプロンプト：テンプレートの指示テキスト + オプションの前のエントリ + オプションの以前のメモリ + コンパイルされたシーンテキストを使用します。JSON スキーマは不要です（オプションの応答形式はガイダンスのみです）。

- 出力とストレージ
  - メモリパス：1 つの JSON オブジェクト：{ title, content, keywords } → 検索に使用されるメモリエンティティとして保存されます。
  - サイドプロンプト：プレーンテキストコンテンツ → 「名前（STMB SidePrompt）」というタイトルのロアブックエントリとして保存されます（レガシー名は更新のために認識されます）。キーワードは必須ではありません。

- チャットプロンプトへの包含
  - メモリパス：エントリは、タグ/キーワード、優先度、スコープ、およびトークンバジェットを介して選択されます。
  - サイドプロンプト：包含は、各テンプレートのロアブック挿入設定（定数 vs ベクトル化、位置、順序）によって管理されます。

- モデル/プロファイルの選択
  - メモリパス：STMB のサマリープロンプトマネージャーで定義されたメモリプロファイルを使用します。
  - サイドプロンプト：テンプレートレベルの上書きが有効になっていない限り、STMB のデフォルトプロファイル（現在の ST UI をミラーリングする場合があります）を使用します。

- 同時実行とバッチ処理
  - メモリパス：生成ごとに 1 回の実行。
  - サイドプロンプト：メモリ後の実行は、制限された同時実行でバッチ処理されます。結果はプレビューして波状に保存できます。

- トークン/サイズの制御
  - メモリパス：STMB はトークンの使用量を見積もり、JSON 契約を強制します。
  - サイドプロンプト：境界のあるシーンウィンドウをコンパイルし、オプションでいくつかの最近のメモリを追加します。厳密な JSON 強制はありません。

## FAQ スタイルのメモ

- 「これはメッセージの書き方を変えますか？」
  あまり変わりません。主にエントリをキュレートし、STMB が適切なものを自動的に含めるようにします。

- 「実際に AI に送信されたものを見ることができますか？」
  はい、ターミナルをチェックして、何が挿入されたかを確認してください。
