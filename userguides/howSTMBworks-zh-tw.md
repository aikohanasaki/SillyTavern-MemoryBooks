# SillyTavern 記憶書 (STMB) 工作原理 — 輕編程指南

本指南以清晰、輕編程的術語解釋 STMB 的工作原理，專為那些不編寫 SillyTavern 代碼但想了解提示如何構建的用戶而設計。

## STMB 發送給 AI 的內容（記憶生成）

當您運行“生成記憶”時，STMB 會發送一個由兩部分組成的提示：

A) 系統指令（來自“摘要”、“概要”等預設）
- 一個簡短的指令塊，用於：
  - 告知模型分析場景
  - 指示模型僅返回 JSON
  - 定義所需的 JSON 字段
- 像 {{user}} 和 {{char}} 這樣的宏會被替換為您的聊天名稱。
- 這不是您的預設！這些提示是獨立的，可以從 🧩摘要提示管理器進行管理。

B) 用於分析的格式化場景
- STMB 會將您最近的消息格式化為腳本：
  - 可選的先前記憶上下文塊（明確標記為“請勿摘要”）。
  - 當前場景的文字記錄，每條消息一行：
    愛麗絲：…
    鮑勃：…

提示結構骨架
```
— 系統指令（來自您選擇的預設）—
分析以下聊天場景並以 JSON 格式返回記憶。

您必須僅以這種確切的格式返回有效的 JSON：
{
  "title": "簡短的場景標題（1-3 個詞）",
  "content": "…",
  "keywords": ["…","…"]
}

…（預設指南繼續；像 {{user}} 和 {{char}} 這樣的宏已被替換）…

— 場景數據 —
=== 先前場景上下文（請勿摘要）===
上下文 1 - [標題]:
[先前的記憶文本]
關鍵詞：阿爾法、貝塔、…
…（零個或多個先前的記憶）…
=== 先前場景上下文結束 - 僅摘要以下場景 ===

=== 場景文字記錄 ===
{{user}}: …
{{char}}: …
…（每條消息佔一行）
=== 場景結束 ===
```

注意
- 令牌安全：STMB 會估算令牌使用量，並在您超過閾值時發出警告。
- 如果您在“設置”中啟用了傳出正則表達式，STMB 會在發送前立即將您選擇的正則表達式腳本應用於提示文本。

## AI 必須返回的內容（JSON 契約）

AI 必須返回一個包含以下字段的 JSON 對象：
- title: 字符串（短）
- content: 字符串（摘要/記憶文本）
- keywords: 字符串數組（預設推薦的 10-30 個特定術語）

嚴格性和兼容性
- 僅返回 JSON 對象 — 無散文、無解釋。
- 鍵應完全為："title"、"content"、"keywords"。
  - STMB 容忍使用 "summary" 或 "memory_content" 作為內容，但 "content" 是最佳實踐。
- keywords 必須是字符串數組（而不是逗號分隔的字符串）。

最小示例（有效）
```json
{
  "title": "安靜的懺悔",
  "content": "深夜，愛麗絲承認黑客攻擊是出於個人原因。鮑勃質疑其道德性；他們就界限達成一致，並計劃下一步謹慎行事。",
  "keywords": ["愛麗絲", "鮑勃", "懺悔", "界限", "黑客攻擊", "道德", "夜晚", "下一步"]
}
```

較長示例（有效）
```json
{
  "title": "屋頂休戰",
  "content": "時間線：市場事件後的夜晚。故事情節：愛麗絲透露她安放了追踪器。鮑勃雖然沮喪但還是傾聽了；他們重播了線索並確定了倉庫。關鍵互動：愛麗絲毫無藉口地道歉；鮑勃設定了繼續合作的條件。值得注意的細節：壞掉的收音機、倉庫標籤“K-17”、遠處的警報聲。結果：他們達成了臨時休戰，並同意在黎明時偵察 K-17。",
  "keywords": ["愛麗絲", "鮑勃", "休戰", "倉庫 K-17", "道歉", "條件", "警報聲", "偵察計劃", "夜晚", "市場事件"]
}
```

### 如果模型行為不當

STMB 會嘗試修復輕微格式錯誤的輸出：
- 接受代碼圍欄內的 JSON 並提取該塊。
- 在解析前刪除註釋和尾隨逗號。
- 檢測截斷/不平衡的 JSON 並引發明確的錯誤，例如：
  - NO_JSON_BLOCK — 模型返回了散文而不是 JSON
  - UNBALANCED / INCOMPLETE_SENTENCE — 可能已截斷
  - MISSING_FIELDS_TITLE / MISSING_FIELDS_CONTENT / INVALID_KEYWORDS — 架構問題

最佳模型行為
- 發出包含所需字段的單個 JSON 對象。
- 不要添加周圍的文本或 Markdown 圍欄。
- 保持“title”簡短；使“keywords”具體且易於檢索。
- 遵守預設（例如，忽略 [OOC] 內容）。

### 高級：執行路徑（可選）

- 提示組裝：buildPrompt(profile, scene) 將所選預設的指令文本與場景文字記錄和可選的先前記憶塊相結合。
- 發送：sendRawCompletionRequest() 將文本提交給您選擇的提供商/模型。
- 解析：parseAIJsonResponse() 提取並驗證標題/內容/關鍵字，並在需要時進行輕微修復。
- 結果：STMB 存儲結構化記憶，應用您的標題格式，並準備建議的知識庫密鑰。

## 側邊提示（操作方法）

側邊提示是輔助性的、由模板驅動的生成器，可將結構化筆記寫回您的知識庫（例如，追踪器、報告、演員表）。它們與“記憶生成”路徑分開，可以自動運行或按需運行。

它們的優點
- 情節/狀態追踪器（例如，“情節要點”）
- 狀態/關係儀表板（例如，“狀態”）
- 演員表/NPC 簡介（例如，“角色陣容”）
- POV 筆記或評估（例如，“評估”）

內置模板（由 STMB 提供）
- 情節要點 — 追踪故事線索和鉤子
- 狀態 — 總結關係/親和力信息
- 角色陣容 — 按情節重要性順序保留 NPC 列表
- 評估 — 記錄 {{char}} 對 {{user}} 的了解

管理位置
- 打開側邊提示管理器（在 STMB 內）以查看、創建、導入/導出、啟用或配置模板。

創建或啟用側邊提示
1) 打開側邊提示管理器。
2) 創建一個新模板或啟用一個內置模板。
3) 配置：
   - 名稱：顯示標題（保存的知識庫條目將標題為“名稱 (STMB SidePrompt)”）。
   - 提示：模型將遵循的指令文本。
   - 響應格式：附加到提示的可選指導塊（不是架構，只是說明）。
   - 觸發器：
     • 記憶後 — 在當前場景的每次成功記憶生成後運行。
     • 按間隔 — 當自上次運行以來可見的用戶/助手消息達到閾值時運行 (visibleMessages)。
     • 手動命令 — 允許使用 /sideprompt 運行。
   - 可選上下文：previousMemoriesCount (0–7) 以包含最近的記憶作為只讀上下文。
   - 模型/配置文件：可選擇覆蓋模型/配置文件 (overrideProfileEnabled + overrideProfileIndex)。否則，它將使用 STMB 默認配置文件（如果已配置，可以鏡像當前的 ST UI 設置）。
   - 知識庫注入設置：
     • constVectMode：鏈接（矢量化，默認）、綠色（正常）、藍色（常量）
     • position：插入策略
     • orderMode/orderValue：需要時手動排序
     • preventRecursion/delayUntilRecursion：布爾標誌

使用 /sideprompt 手動運行
- 語法：/sideprompt "名稱" [X‑Y]
  - 示例：
    • /sideprompt "狀態"
    • /sideprompt 演員表 100‑120
- 如果您省略範圍，STMB 將編譯自上次檢查點以來的消息（限制在最近的窗口內）。
- 手動運行要求模板允許 sideprompt 命令（在模板設置中啟用“允許通過 /sideprompt 手動運行”）。如果禁用，該命令將被拒絕。

自動運行
- 記憶後：所有啟用了 onAfterMemory 觸發器的模板都使用已編譯的場景運行。STMB 以較小的並發限制批量運行，並可以顯示每個模板的成功/失敗信息。
- 間隔追踪器：啟用了 onInterval 的模板在自上次運行以來可見的（非系統）消息數達到 visibleMessages 後運行。STMB 為每個模板存儲檢查點（例如，STMB_sp_<key>_lastMsgId）並對運行進行去抖動處理（約 10 秒）。為了安全起見，場景編譯被限制在最近的窗口內。

預覽和保存
- 如果在 STMB 設置中啟用了“顯示記憶預覽”，則會出現一個預覽彈出窗口。您可以接受、編輯、重試或取消。接受的內容將以“名稱 (STMB SidePrompt)”為標題寫入您綁定的知識庫。
- 側邊提示需要將記憶知識庫綁定到聊天（或在手動模式下選擇）。如果未綁定，STMB 將顯示通知並跳過運行。

導入/導出和內置重置
- 導出：將您的側邊提示文檔另存為 JSON。
- 導入：以附加方式合併條目；重複項會被安全地重命名（不覆蓋）。
- 重新創建內置模板：將內置模板重置為當前區域設置的默認值（用戶創建的模板不受影響）。

## 側邊提示與記憶路徑：主要區別

- 目的
  - 記憶路徑：以嚴格的 JSON（標題、內容、關鍵字）格式生成規範的場景記憶，以供檢索。
  - 側邊提示：以自由格式的文本生成輔助報告/追踪器，並保存到您的知識庫中。

- 運行時間
  - 記憶路徑：僅在您按下“生成記憶”時（或通過其工作流）運行。
  - 側邊提示：可以在記憶後、按間隔閾值或使用 /sideprompt 手動運行。

- 提示形狀
  - 記憶路徑：使用具有嚴格 JSON 契約的專用“摘要提示管理器”預設；STMB 驗證/修復 JSON。
  - 側邊提示：使用模板的指令文本 + 可選的先前條目 + 可選的先前記憶 + 編譯的場景文本；不需要 JSON 架構（可選的響應格式僅為指導）。

- 輸出和存儲
  - 記憶路徑：一個 JSON 對象：{ title, content, keywords } → 作為用於檢索的記憶條目存儲。
  - 側邊提示：純文本內容 → 作為標題為“名稱 (STMB SidePrompt)”的知識庫條目存儲（舊名稱會被識別以進行更新）。不需要關鍵字。

- 包含到聊天提示中
  - 記憶路徑：通過標籤/關鍵字、優先級、範圍和令牌預算選擇條目。
  - 側邊提示：包含由每個模板的知識庫注入設置（常量與矢量化、位置、順序）控制。

- 模型/配置文件選擇
  - 記憶路徑：使用 STMB 摘要提示管理器中定義的記憶配置文件。
  - 側邊提示：除非啟用了模板級覆蓋，否則使用 STMB 默認配置文件（可能鏡像當前的 ST UI）。

- 並發和批處理
  - 記憶路徑：每次生成運行一次。
  - 側邊提示：記憶後運行以有限的並發性進行批處理；結果可以分批預覽和保存。

- 令牌/大小控制
  - 記憶路徑：STMB 估算令牌使用量並強制執行 JSON 契約。
  - 側邊提示：編譯一個有界的場景窗口，並可選擇添加一些最近的記憶；沒有嚴格的 JSON 強制執行。

## 常見問題解答式說明

- “這會改變我寫消息的方式嗎？”
  不會有太大變化。您主要負責管理條目，讓 STMB 自動包含正確的條目。

- “我能看到實際發送給 AI 的內容嗎？”
  可以——檢查您的終端以檢查注入的內容。
