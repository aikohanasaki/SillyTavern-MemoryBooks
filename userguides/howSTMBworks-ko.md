# SillyTavern 메모리 북 (STMB) 작동 방식 — 프로그래머를 위한 가이드 아님

이 가이드는 SillyTavern 코드를 작성하지는 않지만 프롬프트가 어떻게 구성되는지 이해하고 싶은 사용자를 위해 STMB가 어떻게 작동하는지 프로그래머가 아닌 사람도 이해하기 쉬운 용어로 설명합니다.

## STMB가 AI에 보내는 것 (메모리 생성)

"메모리 생성"을 실행하면 STMB는 두 부분으로 구성된 프롬프트를 보냅니다.

A) 시스템 지침 ("요약", "시놉시스" 등과 같은 사전 설정에서)
- 다음을 수행하는 간단한 지침 블록:
  - 모델에 장면을 분석하도록 지시
  - JSON만 반환하도록 지시
  - 필요한 JSON 필드 정의
- {{user}} 및 {{char}}와 같은 매크로는 채팅의 이름으로 대체됩니다.
- 이것은 사용자의 사전 설정이 아닙니다! 이러한 프롬프트는 독립적이며 🧩요약 프롬프트 관리자에서 관리할 수 있습니다.

B) 분석을 위해 형식이 지정된 장면
- STMB는 최근 메시지를 스크립트처럼 형식화합니다.
  - 이전 메모리의 선택적 컨텍스트 블록 (요약하지 않도록 명확하게 표시됨).
  - 현재 장면 스크립트, 메시지당 한 줄:
    앨리스: …
    밥: …

프롬프트 모양의 골격
```
— 시스템 지침 (선택한 사전 설정에서) —
다음 채팅 장면을 분석하고 메모리를 JSON으로 반환하십시오.

이 정확한 형식으로 유효한 JSON만 응답해야 합니다.
{
  "title": "짧은 장면 제목 (1-3 단어)",
  "content": "…",
  "keywords": ["…","…"]
}

…(사전 설정 안내 계속, {{user}} 및 {{char}}와 같은 매크로는 이미 대체됨)…

— 장면 데이터 —
=== 이전 장면 컨텍스트 (요약하지 않음) ===
컨텍스트 1 - [제목]:
[이전 메모리 텍스트]
키워드: 알파, 베타, …
…(0개 이상의 이전 메모리)…
=== 이전 장면 컨텍스트 끝 - 아래 장면만 요약 ===

=== 장면 스크립트 ===
{{user}}: …
{{char}}: …
… (각 메시지는 별도의 줄에)
=== 장면 끝 ===
```

참고
- 토큰 안전성: STMB는 토큰 사용량을 추정하고 임계값을 초과하면 경고합니다.
- 설정에서 나가는 정규식을 활성화한 경우 STMB는 보내기 직전에 선택한 정규식 스크립트를 프롬프트 텍스트에 적용합니다.

## AI가 반환해야 하는 것 (JSON 계약)

AI는 다음 필드가 있는 단일 JSON 객체를 반환해야 합니다.
- title: 문자열 (짧음)
- content: 문자열 (요약/메모리 텍스트)
- keywords: 문자열 배열 (사전 설정에서 권장하는 10-30개의 특정 용어)

엄격함 및 호환성
- JSON 객체만 반환하십시오 — 산문, 설명 없음.
- 키는 정확히 "title", "content", "keywords"여야 합니다.
  - STMB는 내용에 대해 "summary" 또는 "memory_content"를 허용하지만 "content"가 가장 좋습니다.
- keywords는 문자열 배열이어야 합니다 (쉼표로 구분된 문자열이 아님).

최소 예제 (유효)
```json
{
  "title": "조용한 고백",
  "content": "늦은 저녁, 앨리스는 해킹이 개인적인 것이었다고 인정합니다. 밥은 윤리에 의문을 제기하고 그들은 경계에 동의하고 신중한 다음 단계를 계획합니다.",
  "keywords": ["앨리스", "밥", "고백", "경계", "해킹", "윤리", "저녁", "다음 단계"]
}
```

더 긴 예제 (유효)
```json
{
  "title": "옥상 휴전",
  "content": "타임라인: 시장 사건 후 밤. 스토리 비트: 앨리스는 자신이 추적기를 심었다고 밝힙니다. 밥은 좌절하지만 듣고, 그들은 단서를 재생하고 창고를 식별합니다. 주요 상호 작용: 앨리스는 변명 없이 사과하고 밥은 계속하기 위한 조건을 설정합니다. 주목할만한 세부 사항: 깨진 라디오, 창고 라벨 \"K-17\", 멀리서 들리는 사이렌. 결과: 그들은 잠정적인 휴전을 형성하고 새벽에 K-17을 정찰하기로 동의합니다.",
  "keywords": ["앨리스", "밥", "휴전", "창고 K-17", "사과", "조건", "사이렌", "정찰 계획", "밤", "시장 사건"]
}
```

### 모델이 잘못 작동하는 경우

STMB는 약간 잘못된 형식의 출력을 복구하려고 시도합니다.
- 코드 펜스 내부의 JSON을 수락하고 블록을 추출합니다.
- 구문 분석 전에 주석과 후행 쉼표를 제거합니다.
- 잘리거나 불균형한 JSON을 감지하고 다음과 같은 명확한 오류를 발생시킵니다.
  - NO_JSON_BLOCK — 모델이 JSON 대신 산문으로 응답했습니다.
  - UNBALANCED / INCOMPLETE_SENTENCE — 잘렸을 가능성이 높습니다.
  - MISSING_FIELDS_TITLE / MISSING_FIELDS_CONTENT / INVALID_KEYWORDS — 스키마 문제

최상의 모델 동작
- 필요한 필드가 있는 단일 JSON 객체를 내보냅니다.
- 주변 텍스트나 마크다운 펜스를 추가하지 마십시오.
- "title"을 짧게 유지하고 "keywords"를 구체적이고 검색하기 쉽게 만드십시오.
- 사전 설정을 준수하십시오 (예: [OOC] 내용 무시).

### 고급: 실행 경로 (선택 사항)

- 프롬프트 조합: buildPrompt(profile, scene)은 선택한 사전 설정의 지침 텍스트를 장면 스크립트 및 선택적 이전 메모리 블록과 결합합니다.
- 보내기: sendRawCompletionRequest()는 선택한 공급자/모델에 텍스트를 제출합니다.
- 구문 분석: parseAIJsonResponse()는 필요한 경우 약간의 수리를 통해 제목/내용/키워드를 추출하고 유효성을 검사합니다.
- 결과: STMB는 구조화된 메모리를 저장하고 제목 형식을 적용하며 제안된 로어북 키를 준비합니다.

## 사이드 프롬프트 (방법)

사이드 프롬프트는 로어북에 구조화된 노트를 다시 작성하는 템플릿 기반 보조 생성기입니다 (예: 추적기, 보고서, 출연진 목록). "메모리 생성" 경로와는 별개이며 자동으로 또는 요청 시 실행할 수 있습니다.

유용한 기능
- 줄거리/상태 추적기 (예: "줄거리 포인트")
- 상태/관계 대시보드 (예: "상태")
- 출연진 목록 / NPC 인물 소개 (예: "등장인물")
- POV 노트 또는 평가 (예: "평가")

내장 템플릿 (STMB 제공)
- 줄거리 포인트 — 이야기 스레드 및 후크 추적
- 상태 — 관계/친화도 정보 요약
- 등장인물 — 줄거리 중요도 순으로 NPC 목록 유지
- 평가 — {{char}}가 {{user}}에 대해 배운 내용 기록

관리 위치
- 사이드 프롬프트 관리자 (STMB 내)를 열어 템플릿을 보거나, 만들거나, 가져오거나/내보내거나, 활성화하거나, 구성합니다.

사이드 프롬프트 만들기 또는 활성화
1) 사이드 프롬프트 관리자를 엽니다.
2) 새 템플릿을 만들거나 내장 템플릿을 활성화합니다.
3) 구성:
   - 이름: 표시 제목 (저장된 로어북 항목의 제목은 "이름 (STMB SidePrompt)"이 됩니다).
   - 프롬프트: 모델이 따를 지침 텍스트.
   - 응답 형식: 프롬프트에 추가되는 선택적 안내 블록 (스키마가 아니라 지침일 뿐입니다).
   - 트리거:
     • 메모리 후 — 현재 장면에 대한 각 성공적인 메모리 생성 후 실행됩니다.
     • 간격마다 — 마지막 실행 이후 표시되는 사용자/어시스턴트 메시지의 임계값에 도달하면 실행됩니다 (visibleMessages).
     • 수동 명령 — /sideprompt로 실행 허용.
   - 선택적 컨텍스트: previousMemoriesCount (0–7)는 최근 메모리를 읽기 전용 컨텍스트로 포함합니다.
   - 모델/프로필: 선택적으로 모델/프로필을 재정의합니다 (overrideProfileEnabled + overrideProfileIndex). 그렇지 않으면 STMB 기본 프로필을 사용합니다 (구성된 경우 현재 ST UI 설정을 미러링할 수 있음).
   - 로어북 삽입 설정:
     • constVectMode: 링크 (벡터화, 기본값), 녹색 (일반), 파란색 (상수)
     • position: 삽입 전략
     • orderMode/orderValue: 필요한 경우 수동 정렬
     • preventRecursion/delayUntilRecursion: 부울 플래그

/sideprompt로 수동 실행
- 구문: /sideprompt "이름" [X‑Y]
  - 예:
    • /sideprompt "상태"
    • /sideprompt 출연진 100‑120
- 범위를 생략하면 STMB는 마지막 체크포인트 이후의 메시지를 컴파일합니다 (최근 창으로 제한됨).
- 수동 실행을 위해서는 템플릿이 sideprompt 명령을 허용해야 합니다 (템플릿 설정에서 "/sideprompt를 통한 수동 실행 허용" 활성화). 비활성화된 경우 명령이 거부됩니다.

자동 실행
- 메모리 후: onAfterMemory 트리거가 있는 모든 활성화된 템플릿은 이미 컴파일된 장면을 사용하여 실행됩니다. STMB는 작은 동시성 제한으로 실행을 일괄 처리하고 템플릿별 성공/실패 토스트를 표시할 수 있습니다.
- 간격 추적기: onInterval이 있는 활성화된 템플릿은 마지막 실행 이후 표시되는 (시스템이 아닌) 메시지 수가 visibleMessages에 도달하면 실행됩니다. STMB는 템플릿별로 체크포인트를 저장하고 (예: STMB_sp_<key>_lastMsgId) 실행을 디바운스합니다 (~10초). 장면 컴파일은 안전을 위해 최근 창으로 제한됩니다.

미리보기 및 저장
- STMB 설정에서 "메모리 미리보기 표시"가 활성화된 경우 미리보기 팝업이 나타납니다. 수락, 편집, 재시도 또는 취소할 수 있습니다. 수락된 내용은 바인딩된 로어북에 "이름 (STMB SidePrompt)"으로 작성됩니다.
- 사이드 프롬프트는 채팅에 바인딩된 (또는 수동 모드에서 선택된) 메모리 로어북이 필요합니다. 바인딩된 것이 없으면 STMB는 알림을 표시하고 실행을 건너뜁니다.

가져오기/내보내기 및 내장 재설정
- 내보내기: 사이드 프롬프트 문서를 JSON으로 저장합니다.
- 가져오기: 항목을 추가적으로 병합합니다. 중복 항목은 안전하게 이름이 변경됩니다 (덮어쓰기 없음).
- 내장 다시 만들기: 내장 템플릿을 현재 로케일 기본값으로 재설정합니다 (사용자가 만든 템플릿은 변경되지 않음).

## 사이드 프롬프트 대 메모리 경로: 주요 차이점

- 목적
  - 메모리 경로: 검색을 위해 엄격한 JSON (제목, 내용, 키워드)으로 정식 장면 메모리를 생성합니다.
  - 사이드 프롬프트: 로어북에 저장되는 자유 형식 텍스트로 보조 보고서/추적기를 생성합니다.

- 실행 시기
  - 메모리 경로: 메모리 생성을 누를 때만 실행됩니다 (또는 워크플로를 통해).
  - 사이드 프롬프트: 메모리 후, 간격 임계값에서 또는 /sideprompt로 수동으로 실행할 수 있습니다.

- 프롬프트 모양
  - 메모리 경로: 엄격한 JSON 계약이 있는 전용 "요약 프롬프트 관리자" 사전 설정을 사용하고 STMB가 JSON을 확인/수리합니다.
  - 사이드 프롬프트: 템플릿의 지침 텍스트 + 선택적 이전 항목 + 선택적 이전 메모리 + 컴파일된 장면 텍스트를 사용합니다. JSON 스키마가 필요하지 않습니다 (선택적 응답 형식은 안내일 뿐입니다).

- 출력 및 저장
  - 메모리 경로: 하나의 JSON 객체: { title, content, keywords } → 검색에 사용되는 메모리 항목으로 저장됩니다.
  - 사이드 프롬프트: 일반 텍스트 내용 → "이름 (STMB SidePrompt)"이라는 제목의 로어북 항목으로 저장됩니다 (레거시 이름은 업데이트를 위해 인식됨). 키워드는 필요하지 않습니다.

- 채팅 프롬프트에 포함
  - 메모리 경로: 항목은 태그/키워드, 우선 순위, 범위 및 토큰 예산을 통해 선택됩니다.
  - 사이드 프롬프트: 포함은 각 템플릿의 로어북 삽입 설정 (상수 대 벡터화, 위치, 순서)에 의해 제어됩니다.

- 모델/프로필 선택
  - 메모리 경로: STMB의 요약 프롬프트 관리자에 정의된 메모리 프로필을 사용합니다.
  - 사이드 프롬프트: 템플릿 수준 재정의가 활성화되지 않은 경우 STMB 기본 프로필 (현재 ST UI를 미러링할 수 있음)을 사용합니다.

- 동시성 및 일괄 처리
  - 메모리 경로: 생성당 단일 실행.
  - 사이드 프롬프트: 메모리 후 실행은 제한된 동시성으로 일괄 처리됩니다. 결과는 미리보고 웨이브로 저장할 수 있습니다.

- 토큰/크기 제어
  - 메모리 경로: STMB는 토큰 사용량을 추정하고 JSON 계약을 적용합니다.
  - 사이드 프롬프트: 제한된 장면 창을 컴파일하고 선택적으로 최근 메모리 몇 개를 추가합니다. 엄격한 JSON 적용은 없습니다.

## FAQ 스타일 노트

- "이것이 메시지 작성 방식을 바꾸나요?"
  별로 그렇지 않습니다. 주로 항목을 선별하고 STMB가 올바른 항목을 자동으로 포함하도록 합니다.

- "실제로 AI에 무엇이 전송되었는지 볼 수 있나요?"
  예—터미널을 확인하여 무엇이 삽입되었는지 검사하십시오.
